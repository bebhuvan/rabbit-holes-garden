---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getCollection } from 'astro:content';

// Get all posts, sorted by date (newest first)
const allPosts = await getCollection('posts', ({ data }) => !data.draft);
allPosts.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// Group posts by year
const postsByYear = allPosts.reduce((acc, post) => {
  const year = new Date(post.data.date).getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof allPosts>);

const years = Object.keys(postsByYear).map(Number).sort((a, b) => b - a);
---

<Layout title="Archive | Rabbit Holes" description="All posts from Rabbit Holes, organized by year">
  <div class="container">
    <Header />
    
    <main>
      <header class="archive-header">
        <h1 class="archive-title">Archive</h1>
        <p class="archive-description">
          All discoveries, organized by year. {allPosts.length} posts and counting.
        </p>
      </header>
      
      <div class="archive-content">
        {years.map(year => (
          <section class="year-section">
            <h2 class="year-title">{year}</h2>
            <div class="posts-list">
              {postsByYear[year].map(post => (
                <article class="archive-post">
                  <time class="post-date" datetime={post.data.date.toISOString()}>
                    {new Intl.DateTimeFormat('en-US', {
                      month: 'short',
                      day: 'numeric'
                    }).format(post.data.date)}
                  </time>
                  <div class="post-info">
                    <h3 class="post-title">
                      <a href={`/posts/${post.slug}`}>
                        {post.data.title}
                      </a>
                    </h3>
                    <p class="post-excerpt">{post.data.excerpt}</p>
                    <div class="post-tags">
                      {post.data.tags.slice(0, 3).map(tag => (
                        <a href={`/tags/${tag}`} class="tag">#{tag}</a>
                      ))}
                    </div>
                  </div>
                </article>
              ))}
            </div>
          </section>
        ))}
      </div>
    </main>
    
    <Footer />
  </div>
</Layout>

<style>
  .archive-header {
    text-align: center;
    margin-bottom: 80px;
  }
  
  .archive-title {
    font-size: 36px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--text-primary-light);
    font-family: 'Work Sans', sans-serif;
  }
  
  body.dark .archive-title {
    color: var(--text-primary-dark);
  }
  
  .archive-description {
    font-size: 16px;
    color: var(--text-secondary-light);
    max-width: 480px;
    margin: 0 auto;
  }
  
  body.dark .archive-description {
    color: var(--text-secondary-dark);
  }
  
  .year-section {
    margin-bottom: 80px;
  }
  
  .year-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 32px;
    color: var(--text-primary-light);
    font-family: 'Work Sans', sans-serif;
    border-bottom: 2px solid var(--accent-orange);
    padding-bottom: 8px;
    display: inline-block;
  }
  
  body.dark .year-title {
    color: var(--text-primary-dark);
  }
  
  .posts-list {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }
  
  .archive-post {
    display: flex;
    gap: 24px;
    padding: 24px 0;
    border-bottom: 1px solid var(--border-light);
    transition: all 0.2s ease;
  }
  
  .archive-post:hover {
    opacity: 0.8;
  }
  
  body.dark .archive-post {
    border-bottom-color: var(--border-dark);
  }
  
  .post-date {
    font-size: 12px;
    color: var(--text-tertiary-light);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 500;
    min-width: 60px;
    text-align: right;
    padding-top: 4px;
  }
  
  body.dark .post-date {
    color: var(--text-tertiary-dark);
  }
  
  .post-info {
    flex: 1;
  }
  
  .post-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
    font-family: 'Work Sans', sans-serif;
    line-height: 1.3;
  }
  
  .post-title a {
    color: var(--text-primary-light);
    text-decoration: none;
    transition: color 0.2s ease;
  }
  
  .post-title a:hover {
    color: var(--accent-orange);
  }
  
  body.dark .post-title a {
    color: var(--text-primary-dark);
  }
  
  .post-excerpt {
    font-size: 14px;
    color: var(--text-secondary-light);
    line-height: 1.5;
    margin-bottom: 12px;
  }
  
  body.dark .post-excerpt {
    color: var(--text-secondary-dark);
  }
  
  .post-tags {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  .tag {
    color: var(--text-tertiary-light);
    text-decoration: none;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: color 0.2s ease;
  }
  
  .tag:hover {
    color: var(--text-secondary-light);
  }
  
  body.dark .tag {
    color: var(--text-tertiary-dark);
  }
  
  body.dark .tag:hover {
    color: var(--text-secondary-dark);
  }
  
  @media (max-width: 768px) {
    .archive-post {
      flex-direction: column;
      gap: 12px;
    }
    
    .post-date {
      text-align: left;
      min-width: auto;
    }
    
    .archive-title {
      font-size: 28px;
    }
  }
</style>